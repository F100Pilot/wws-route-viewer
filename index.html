<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WWS Route Viewer – GitHub Pages</title>
  <meta name="description" content="Visualizador de rotas WWS. Carrega automaticamente wws-routes.xlsx do mesmo repositório (Ida & Volta)." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-4 sm:p-6">
    <header class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold">WWS Route Viewer</h1>
      <p class="text-sm text-slate-600">
        Esta versão para <strong>GitHub Pages</strong> carrega automaticamente o ficheiro
        <code>wws-routes.xlsx</code> da raiz do repositório.
      </p>
      <p class="text-xs text-slate-500 mt-1">
        Dica: sempre que substituíres o Excel no repositório, a página atualiza (usa cache‑busting).
      </p>
    </header>

    <section id="filters" class="mb-4 hidden">
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-xs font-medium">Pesquisar (ICAO, país, nº voo)</label>
          <input id="q" type="text" placeholder="ex.: WWS0105, LPPT, Japão" class="rounded-md border border-slate-300 bg-white p-2 w-64" />
        </div>
        <div>
          <label class="block text-xs font-medium">Tipo de voo</label>
          <select id="tipo" class="rounded-md border border-slate-300 bg-white p-2">
            <option value="">Todos</option>
            <option>Nonstop</option>
            <option>1-Stop</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium">Curso</label>
          <select id="curso" class="rounded-md border border-slate-300 bg-white p-2">
            <option value="">Todos</option>
            <option>Médio</option>
            <option>Longo</option>
          </select>
        </div>
        <button id="limpar" class="ml-auto rounded-lg border px-3 py-2 bg-white hover:bg-slate-100">Limpar filtros</button>
      </div>
    </section>

    <section id="scheduler" class="mb-6 hidden">
      <div class="rounded-2xl border bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between gap-3 mb-3">
          <h2 class="text-lg font-semibold">Scheduler</h2>
          <div class="flex gap-2">
            <button id="btnSorteia" class="rounded-md bg-slate-900 text-white px-3 py-2">Sortear voo</button>
            <button id="btnProximo" class="rounded-md border px-3 py-2">Voo seguinte</button>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-medium mb-2">Atribuído</h3>
            <div id="assigned" class="text-sm"></div>
          </div>
          <div>
            <h3 class="font-medium mb-2">Seguinte sugerido</h3>
            <div id="next" class="text-sm"></div>
          </div>
        </div>
        <div class="mt-4 text-xs text-slate-600">
          <p><span class="font-semibold">Última chegada</span>: <span id="lastArr">—</span></p>
        </div>
      </div>
    </section>

    <section>
      <div id="tableWrap" class="rounded-2xl border bg-white p-3 shadow-sm overflow-auto">
        <table id="tbl" class="min-w-full text-sm">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // === CONFIG: caminho do Excel no mesmo repo ===
    const EXCEL_URL = "./wws-routes.xlsx";

    // --- Utilities ---
    const storage = {
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
      get(k, d=null){ try { return JSON.parse(localStorage.getItem(k)); } catch(e){return d;} }
    };
    const pairReturn = (n) => {
      const m = (n||'').match(/^(WWS)(\\d{4})$/); if(!m) return n;
      const num = parseInt(m[2],10); const ret = num % 2 === 0 ? num-1 : num+1;
      return `WWS${String(Math.max(0, Math.min(9999, ret))).padStart(4,'0')}`;
    };
    const renderObj = (obj) => {
      if(!obj) return '<div class="text-slate-500">—</div>';
      const fields = ["N_Voo","Tipo_Voo","Origem_ICAO","Destino_ICAO","GreatCircle_nm","Tempo_Voo_HHMM","Curso","Aeronave","Trecho","Escala_ICAO"];
      return `<div class="grid grid-cols-2 gap-1">${fields.map(f=>`<div class='text-slate-500'>${f}</div><div class='font-medium'>${obj[f] ?? ''}</div>`).join('')}</div>`;
    };

    // --- State ---
    let dataIda = [], dataVolta = [];
    let currentView = 'Ida';
    let currentData = [];
    let sortKey = null, sortDir = 'asc';

    // --- DOM refs ---
    const $thead = document.getElementById('thead');
    const $tbody = document.getElementById('tbody');
    const $filters = document.getElementById('filters');
    const $scheduler = document.getElementById('scheduler');
    const $q = document.getElementById('q');
    const $tipo = document.getElementById('tipo');
    const $curso = document.getElementById('curso');
    const $limpar = document.getElementById('limpar');
    const $btnIda = document.getElementById('btnIda');
    const $btnVolta = document.getElementById('btnVolta');
    const $btnSorteia = document.getElementById('btnSorteia');
    const $btnProximo = document.getElementById('btnProximo');
    const $assigned = document.getElementById('assigned');
    const $next = document.getElementById('next');
    const $lastArr = document.getElementById('lastArr');

    function updateLastArr(val){ $lastArr.textContent = val || '—'; storage.set('WWS_last_arrival', val || null); }

    function readSheet(sheet){
      const aoa = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});
      if(!aoa.length) return [];
      const headers = aoa[0];
      return aoa.slice(1).map(row=>{
        const obj={}; headers.forEach((h,i)=>obj[h]=row[i]); return obj;
      });
    }

    function sortRows(rows){
      if(!sortKey) return rows;
      const dir = sortDir === 'asc' ? 1 : -1;
      const isNumbery = (v)=> !isNaN(parseFloat(v)) && isFinite(v);
      return [...rows].sort((a,b)=>{
        const va = a[sortKey], vb = b[sortKey];
        if(isNumbery(va) && isNumbery(vb)) return (parseFloat(va)-parseFloat(vb))*dir;
        return String(va).localeCompare(String(vb), 'pt', {numeric:true})*dir;
      });
    }

    function renderTable(data){
      if(!data || !data.length){
        $thead.innerHTML='';
        $tbody.innerHTML='<tr><td class="p-3 text-slate-500">Sem dados.</td></tr>';
        return;
      }
      const headers = Object.keys(data[0]);
      $thead.innerHTML = `<tr>${headers.map(h=>{
        const active = h===sortKey ? (sortDir==='asc'?' ▲':' ▼') : '';
        return `<th data-key="${h}" class='sortable text-left text-xs uppercase tracking-wide text-slate-500 p-2 border-b cursor-pointer select-none'>${h}${active}</th>`;
      }).join('')}</tr>`;
      const html = data.map(r=>`<tr class='hover:bg-slate-50'>${headers.map(h=>`<td class='p-2 border-b whitespace-nowrap'>${r[h]}</td>`).join('')}</tr>`).join('');
      $tbody.innerHTML = html;
      [...$thead.querySelectorAll('th.sortable')].forEach(th=>{
        th.onclick = ()=>{
          const key = th.getAttribute('data-key');
          if(sortKey===key){ sortDir = (sortDir==='asc'?'desc':'asc'); } else { sortKey = key; sortDir='asc'; }
          applyFilters();
        };
      });
    }

    function applyFilters(){
      const base = (currentView==='Ida'? dataIda : dataVolta) || [];
      const q = ($q.value||'').toLowerCase();
      const tipo = $tipo.value; const curso = $curso.value;
      const filtered = base.filter(r=>{
        const text = `${r['N_Voo']} ${r['Origem_ICAO']} ${r['Destino_ICAO']} ${r['País_Origem']||''} ${r['País_Destino']||''}`.toLowerCase();
        if(q && !text.includes(q)) return false;
        if(tipo && r['Tipo_Voo']!==tipo) return false;
        if(curso && r['Curso']!==curso) return false;
        return true;
      });
      currentData = sortRows(filtered);
      renderTable(currentData);
    }

    function suggestNext(leg){
      if(!leg) return null;
      if((leg['Trecho']||'').trim()==='1/2'){
        const cont = dataIda.find(r=> r['N_Voo']===leg['N_Voo'] && r['Trecho']==='2/2');
        if(cont){ return cont; }
      }
      const paired = pairReturn(leg['N_Voo']);
      const o = leg['Destino_ICAO'];
      const d = leg['Origem_ICAO'];
      const back = dataVolta.find(r=> r['N_Voo']===paired && r['Origem_ICAO']===o && r['Destino_ICAO']===d);
      if(back){ return back; }
      const last = storage.get('WWS_last_arrival', o);
      const any = dataVolta.find(r=> r['Origem_ICAO']===last);
      if(any){ return any; }
      return null;
    }

    function pickRandomFirstLeg(){
      const base = dataIda.filter(r=> r['Trecho']==='1/1' || r['Trecho']==='1/2');
      let startFrom = storage.get('WWS_last_arrival', null);
      let pool = base;
      if(startFrom){ pool = base.filter(r=> r['Origem_ICAO']===startFrom); }
      if(pool.length===0) pool = base;
      const chosen = pool[Math.floor(Math.random()*pool.length)];
      storage.set('WWS_last_flight', chosen['N_Voo']);
      updateLastArr(chosen['Destino_ICAO']);
      $assigned.innerHTML = renderObj(chosen);
      const next = suggestNext(chosen);
      $next.innerHTML = renderObj(next);
      storage.set('WWS_assigned', chosen);
    }

    function commitNextFlight(){
      const assigned = storage.get('WWS_assigned', null);
      let next = null;
      if(assigned){ next = suggestNext(assigned); }
      if(!next){
        const base = (currentView==='Ida'? dataIda : dataVolta);
        next = (base && base.length? base[0] : null);
      }
      if(!next){ return; }
      storage.set('WWS_assigned', next);
      storage.set('WWS_last_flight', next['N_Voo']);
      updateLastArr(next['Destino_ICAO']);
      $assigned.innerHTML = renderObj(next);
      const following = suggestNext(next);
      $next.innerHTML = renderObj(following);
    }

    async function loadFromRepo(){
      const url = EXCEL_URL + (EXCEL_URL.includes('?')?'&':'?') + 'ts=' + Date.now();
      const resp = await fetch(url);
      if(!resp.ok) throw new Error('HTTP '+resp.status+' ao carregar '+url);
      const buf = await resp.arrayBuffer();
      const book = XLSX.read(buf, {type:'array'});
      const shIda = book.Sheets['Ida'];
      const shVolta = book.Sheets['Volta'];
      if(!shIda || !shVolta) throw new Error('Faltam as abas \"Ida\" e \"Volta\"');
      dataIda = readSheet(shIda);
      dataVolta = readSheet(shVolta);
      $filters.classList.remove('hidden');
      $scheduler.classList.remove('hidden');
      updateLastArr(storage.get('WWS_last_arrival', null));
      currentView='Ida'; applyFilters();
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      try{
        await loadFromRepo();
      }catch(err){
        const warn = document.createElement('div');
        warn.className = 'mb-4 rounded-md border border-amber-300 bg-amber-50 p-3 text-amber-800';
        warn.innerHTML = 'Não foi possível carregar <code>wws-routes.xlsx</code> da raiz do repositório. Verifica se o ficheiro existe e tem as abas <b>Ida</b> e <b>Volta</b>.';
        document.querySelector('.max-w-7xl').prepend(warn);
      }
    });

    // UI events
    document.getElementById('btnIda').addEventListener('click', ()=>{ currentView='Ida'; applyFilters(); });
    document.getElementById('btnVolta').addEventListener('click', ()=>{ currentView='Volta'; applyFilters(); });
    document.getElementById('q').addEventListener('input', applyFilters);
    document.getElementById('tipo').addEventListener('change', applyFilters);
    document.getElementById('curso').addEventListener('change', applyFilters);
    document.getElementById('limpar').addEventListener('click', ()=>{ document.getElementById('q').value=''; document.getElementById('tipo').value=''; document.getElementById('curso').value=''; applyFilters(); });
    document.getElementById('btnSorteia').addEventListener('click', pickRandomFirstLeg);
    document.getElementById('btnProximo').addEventListener('click', commitNextFlight);
  </script>
</body>
</html>
